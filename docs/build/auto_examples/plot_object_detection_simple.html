

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Object Detection Test &mdash; TensorFlow 2 Object Detection API tutorial  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
  <link rel="stylesheet" href="../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../_static/gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../_static/gallery-dataframe.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Common issues" href="../issues.html" />
    <link rel="prev" title="Detect Objects Using Your Webcam" href="object_detection_camera.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> TensorFlow 2 Object Detection API tutorial
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../training.html">Training Custom Object Detector</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="object_detection_camera.html">Detect Objects Using Your Webcam</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Object Detection Test</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#create-the-data-directory">Create the data directory</a></li>
<li class="toctree-l3"><a class="reference internal" href="#download-the-test-images">Download the test images</a></li>
<li class="toctree-l3"><a class="reference internal" href="#download-the-model">Download the model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#load-the-model">Load the model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#load-label-map-data-for-plotting">Load label map data (for plotting)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#putting-everything-together">Putting everything together</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../issues.html">Common issues</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">TensorFlow 2 Object Detection API tutorial</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Examples</a> &raquo;</li>
        
      <li>Object Detection Test</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/auto_examples/plot_object_detection_simple.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-auto-examples-plot-object-detection-simple-py"><span class="std std-ref">here</span></a>     to download the full example code</p>
</div>
<div class="sphx-glr-example-title section" id="object-detection-test">
<span id="sphx-glr-auto-examples-plot-object-detection-simple-py"></span><h1>Object Detection Test<a class="headerlink" href="#object-detection-test" title="Permalink to this headline">¶</a></h1>
<p>This demo will take you through the steps of running an “out-of-the-box” detection model on a
collection of images.</p>
<div class="section" id="create-the-data-directory">
<h2>Create the data directory<a class="headerlink" href="#create-the-data-directory" title="Permalink to this headline">¶</a></h2>
<p>The snippet shown below will create the <code class="docutils literal notranslate"><span class="pre">data</span></code> directory where all our data will be stored. The
code will create a directory structure as shown bellow:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>data
├── images
└── models
</pre></div>
</div>
<p>where the <code class="docutils literal notranslate"><span class="pre">images</span></code> folder will contain the downlaoded test images, while <code class="docutils literal notranslate"><span class="pre">models</span></code> will
contain the downloaded models.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="n">DATA_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;data&#39;</span><span class="p">)</span>
<span class="n">IMAGES_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="s1">&#39;images&#39;</span><span class="p">)</span>
<span class="n">MODELS_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="s1">&#39;models&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="nb">dir</span> <span class="ow">in</span> <span class="p">[</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="n">IMAGES_DIR</span><span class="p">,</span> <span class="n">MODELS_DIR</span><span class="p">]:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="nb">dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="download-the-test-images">
<h2>Download the test images<a class="headerlink" href="#download-the-test-images" title="Permalink to this headline">¶</a></h2>
<p>First we will download the images that we will use throughout this tutorial. The code snippet
shown bellow will download the test images from the <a class="reference external" href="https://github.com/tensorflow/models/tree/master/research/object_detection/test_images">TensorFlow Model Garden</a>
and save them inside the <code class="docutils literal notranslate"><span class="pre">data/images</span></code> folder.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">urllib.request</span>

<span class="n">IMAGE_FILENAMES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;image1.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;image2.jpg&#39;</span><span class="p">]</span>
<span class="n">IMAGES_DOWNLOAD_BASE</span> <span class="o">=</span> \
    <span class="s1">&#39;https://raw.githubusercontent.com/tensorflow/models/master/research/object_detection/test_images/&#39;</span>

<span class="k">for</span> <span class="n">image_filename</span> <span class="ow">in</span> <span class="n">IMAGE_FILENAMES</span><span class="p">:</span>

    <span class="n">image_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">IMAGES_DIR</span><span class="p">,</span> <span class="n">image_filename</span><span class="p">)</span>

    <span class="c1"># Download image</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">image_path</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Downloading </span><span class="si">{}</span><span class="s1">... &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">image_filename</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">IMAGES_DOWNLOAD_BASE</span> <span class="o">+</span> <span class="n">image_filename</span><span class="p">,</span> <span class="n">image_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Downloading image1.jpg... Done
Downloading image2.jpg... Done
</pre></div>
</div>
</div>
<div class="section" id="download-the-model">
<h2>Download the model<a class="headerlink" href="#download-the-model" title="Permalink to this headline">¶</a></h2>
<p>The code snippet shown below is used to download the object detection model checkpoint file,
as well as the labels file (.pbtxt) which contains a list of strings used to add the correct
label to each detection (e.g. person). Once downloaded the files will be stored under the
<code class="docutils literal notranslate"><span class="pre">data/models</span></code> folder.</p>
<p>The particular detection algorithm we will use is the <cite>CenterNet HourGlass104 1024x1024</cite>. More
models can be found in the <a class="reference external" href="https://github.com/tensorflow/models/blob/master/research/object_detection/g3doc/tf2_detection_zoo.md">TensorFlow 2 Detection Model Zoo</a>.
To use a different model you will need the URL name of the specific model. This can be done as
follows:</p>
<ol class="arabic simple">
<li><p>Right click on the <cite>Model name</cite> of the model you would like to use;</p></li>
<li><p>Click on <cite>Copy link address</cite> to copy the download link of the model;</p></li>
<li><p>Paste the link in a text editor of your choice. You should observe a link similar to <code class="docutils literal notranslate"><span class="pre">download.tensorflow.org/models/object_detection/tf2/YYYYYYYY/XXXXXXXXX.tar.gz</span></code>;</p></li>
<li><p>Copy the <code class="docutils literal notranslate"><span class="pre">XXXXXXXXX</span></code> part of the link and use it to replace the value of the <code class="docutils literal notranslate"><span class="pre">MODEL_NAME</span></code> variable in the code shown below;</p></li>
<li><p>Copy the <code class="docutils literal notranslate"><span class="pre">YYYYYYYY</span></code> part of the link and use it to replace the value of the <code class="docutils literal notranslate"><span class="pre">MODEL_DATE</span></code> variable in the code shown below.</p></li>
</ol>
<p>For example, the download link for the model used below is: <code class="docutils literal notranslate"><span class="pre">download.tensorflow.org/models/object_detection/tf2/20200711/centernet_hg104_1024x1024_coco17_tpu-32.tar.gz</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tarfile</span>

<span class="c1"># Download and extract model</span>
<span class="n">MODEL_DATE</span> <span class="o">=</span> <span class="s1">&#39;20200711&#39;</span>
<span class="n">MODEL_NAME</span> <span class="o">=</span> <span class="s1">&#39;centernet_hg104_1024x1024_coco17_tpu-32&#39;</span>
<span class="n">MODEL_TAR_FILENAME</span> <span class="o">=</span> <span class="n">MODEL_NAME</span> <span class="o">+</span> <span class="s1">&#39;.tar.gz&#39;</span>
<span class="n">MODELS_DOWNLOAD_BASE</span> <span class="o">=</span> <span class="s1">&#39;http://download.tensorflow.org/models/object_detection/tf2/&#39;</span>
<span class="n">MODEL_DOWNLOAD_LINK</span> <span class="o">=</span> <span class="n">MODELS_DOWNLOAD_BASE</span> <span class="o">+</span> <span class="n">MODEL_DATE</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">MODEL_TAR_FILENAME</span>
<span class="n">PATH_TO_MODEL_TAR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MODELS_DIR</span><span class="p">,</span> <span class="n">MODEL_TAR_FILENAME</span><span class="p">)</span>
<span class="n">PATH_TO_CKPT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MODELS_DIR</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MODEL_NAME</span><span class="p">,</span> <span class="s1">&#39;checkpoint/&#39;</span><span class="p">))</span>
<span class="n">PATH_TO_CFG</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MODELS_DIR</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MODEL_NAME</span><span class="p">,</span> <span class="s1">&#39;pipeline.config&#39;</span><span class="p">))</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">PATH_TO_CKPT</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Downloading model. This may take a while... &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">MODEL_DOWNLOAD_LINK</span><span class="p">,</span> <span class="n">PATH_TO_MODEL_TAR</span><span class="p">)</span>
    <span class="n">tar_file</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">PATH_TO_MODEL_TAR</span><span class="p">)</span>
    <span class="n">tar_file</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">MODELS_DIR</span><span class="p">)</span>
    <span class="n">tar_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">PATH_TO_MODEL_TAR</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done&#39;</span><span class="p">)</span>

<span class="c1"># Download labels file</span>
<span class="n">LABEL_FILENAME</span> <span class="o">=</span> <span class="s1">&#39;mscoco_label_map.pbtxt&#39;</span>
<span class="n">LABELS_DOWNLOAD_BASE</span> <span class="o">=</span> \
    <span class="s1">&#39;https://raw.githubusercontent.com/tensorflow/models/master/research/object_detection/data/&#39;</span>
<span class="n">PATH_TO_LABELS</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MODELS_DIR</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MODEL_NAME</span><span class="p">,</span> <span class="n">LABEL_FILENAME</span><span class="p">))</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">PATH_TO_LABELS</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Downloading label file... &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">LABELS_DOWNLOAD_BASE</span> <span class="o">+</span> <span class="n">LABEL_FILENAME</span><span class="p">,</span> <span class="n">PATH_TO_LABELS</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Downloading model. This may take a while... Done
Downloading label file... Done
</pre></div>
</div>
</div>
<div class="section" id="load-the-model">
<h2>Load the model<a class="headerlink" href="#load-the-model" title="Permalink to this headline">¶</a></h2>
<p>Next we load the downloaded model</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TF_CPP_MIN_LOG_LEVEL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;2&#39;</span>    <span class="c1"># Suppress TensorFlow logging (1)</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">object_detection.utils</span> <span class="k">import</span> <span class="n">label_map_util</span>
<span class="kn">from</span> <span class="nn">object_detection.utils</span> <span class="k">import</span> <span class="n">config_util</span>
<span class="kn">from</span> <span class="nn">object_detection.utils</span> <span class="k">import</span> <span class="n">visualization_utils</span> <span class="k">as</span> <span class="n">viz_utils</span>
<span class="kn">from</span> <span class="nn">object_detection.builders</span> <span class="k">import</span> <span class="n">model_builder</span>

<span class="n">tf</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="s1">&#39;ERROR&#39;</span><span class="p">)</span>           <span class="c1"># Suppress TensorFlow logging (2)</span>

<span class="c1"># Enable GPU dynamic memory allocation</span>
<span class="n">gpus</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">list_physical_devices</span><span class="p">(</span><span class="s1">&#39;GPU&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">gpu</span> <span class="ow">in</span> <span class="n">gpus</span><span class="p">:</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">set_memory_growth</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1"># Load pipeline config and build a detection model</span>
<span class="n">configs</span> <span class="o">=</span> <span class="n">config_util</span><span class="o">.</span><span class="n">get_configs_from_pipeline_file</span><span class="p">(</span><span class="n">PATH_TO_CFG</span><span class="p">)</span>
<span class="n">model_config</span> <span class="o">=</span> <span class="n">configs</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
<span class="n">detection_model</span> <span class="o">=</span> <span class="n">model_builder</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model_config</span><span class="o">=</span><span class="n">model_config</span><span class="p">,</span> <span class="n">is_training</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Restore checkpoint</span>
<span class="n">ckpt</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Checkpoint</span><span class="p">(</span>
      <span class="n">model</span><span class="o">=</span><span class="n">detection_model</span><span class="p">)</span>
<span class="n">ckpt</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_CKPT</span><span class="p">,</span> <span class="s1">&#39;ckpt-0&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">expect_partial</span><span class="p">()</span>

<span class="nd">@tf</span><span class="o">.</span><span class="n">function</span>
<span class="k">def</span> <span class="nf">detect_fn</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Detect objects in image.&quot;&quot;&quot;</span>

    <span class="n">image</span><span class="p">,</span> <span class="n">shapes</span> <span class="o">=</span> <span class="n">detection_model</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">prediction_dict</span> <span class="o">=</span> <span class="n">detection_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">shapes</span><span class="p">)</span>
    <span class="n">detections</span> <span class="o">=</span> <span class="n">detection_model</span><span class="o">.</span><span class="n">postprocess</span><span class="p">(</span><span class="n">prediction_dict</span><span class="p">,</span> <span class="n">shapes</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">detections</span><span class="p">,</span> <span class="n">prediction_dict</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shapes</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="load-label-map-data-for-plotting">
<h2>Load label map data (for plotting)<a class="headerlink" href="#load-label-map-data-for-plotting" title="Permalink to this headline">¶</a></h2>
<p>Label maps correspond index numbers to category names, so that when our convolution network
predicts <cite>5</cite>, we know that this corresponds to <cite>airplane</cite>.  Here we use internal utility
functions, but anything that returns a dictionary mapping integers to appropriate string labels
would be fine.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">category_index</span> <span class="o">=</span> <span class="n">label_map_util</span><span class="o">.</span><span class="n">create_category_index_from_labelmap</span><span class="p">(</span><span class="n">PATH_TO_LABELS</span><span class="p">,</span>
                                                                    <span class="n">use_display_name</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="putting-everything-together">
<h2>Putting everything together<a class="headerlink" href="#putting-everything-together" title="Permalink to this headline">¶</a></h2>
<p>The code shown below loads an image, runs it through the detection model and visualizes the
detection results, including the keypoints.</p>
<p>Note that this will take a long time (several minutes) the first time you run this code due to
tf.function’s trace-compilation — on subsequent runs (e.g. on new images), things will be
faster.</p>
<p>Here are some simple things to try out if you are curious:</p>
<ul class="simple">
<li><p>Modify some of the input images and see if detection still works. Some simple things to try out here (just uncomment the relevant portions of code) include flipping the image horizontally, or converting to grayscale (note that we still expect the input image to have 3 channels).</p></li>
<li><p>Print out <cite>detections[‘detection_boxes’]</cite> and try to match the box locations to the boxes in the image.  Notice that coordinates are given in normalized form (i.e., in the interval [0, 1]).</p></li>
<li><p>Set <code class="docutils literal notranslate"><span class="pre">min_score_thresh</span></code> to other values (between 0 and 1) to allow more detections in or to filter out more detections.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">six</span> <span class="k">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="k">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>   <span class="c1"># Suppress Matplotlib warnings</span>

<span class="k">def</span> <span class="nf">load_image_into_numpy_array</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load an image from file into a numpy array.</span>

<span class="sd">    Puts image into numpy array to feed into tensorflow graph.</span>
<span class="sd">    Note that by convention we put it into a numpy array with shape</span>
<span class="sd">    (height, width, channels), where channels=3 for RGB.</span>

<span class="sd">    Args:</span>
<span class="sd">      path: the file path to the image</span>

<span class="sd">    Returns:</span>
<span class="sd">      uint8 numpy array with shape (img_height, img_width, 3)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">img_data</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">gfile</span><span class="o">.</span><span class="n">GFile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">img_data</span><span class="p">))</span>
    <span class="p">(</span><span class="n">im_width</span><span class="p">,</span> <span class="n">im_height</span><span class="p">)</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">size</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">getdata</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
        <span class="p">(</span><span class="n">im_height</span><span class="p">,</span> <span class="n">im_width</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>


<span class="k">for</span> <span class="n">image_filename</span> <span class="ow">in</span> <span class="n">IMAGE_FILENAMES</span><span class="p">:</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running inference for </span><span class="si">{}</span><span class="s1">... &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">image_filename</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="n">image_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">IMAGES_DIR</span><span class="p">,</span> <span class="n">image_filename</span><span class="p">)</span>
    <span class="n">image_np</span> <span class="o">=</span> <span class="n">load_image_into_numpy_array</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>

    <span class="c1"># Things to try:</span>
    <span class="c1"># Flip horizontally</span>
    <span class="c1"># image_np = np.fliplr(image_np).copy()</span>

    <span class="c1"># Convert image to grayscale</span>
    <span class="c1"># image_np = np.tile(</span>
    <span class="c1">#     np.mean(image_np, 2, keepdims=True), (1, 1, 3)).astype(np.uint8)</span>

    <span class="n">input_tensor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">convert_to_tensor</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">image_np</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">detections</span><span class="p">,</span> <span class="n">predictions_dict</span><span class="p">,</span> <span class="n">shapes</span> <span class="o">=</span> <span class="n">detect_fn</span><span class="p">(</span><span class="n">input_tensor</span><span class="p">)</span>

    <span class="n">label_id_offset</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">image_np_with_detections</span> <span class="o">=</span> <span class="n">image_np</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">viz_utils</span><span class="o">.</span><span class="n">visualize_boxes_and_labels_on_image_array</span><span class="p">(</span>
          <span class="n">image_np_with_detections</span><span class="p">,</span>
          <span class="n">detections</span><span class="p">[</span><span class="s1">&#39;detection_boxes&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
          <span class="p">(</span><span class="n">detections</span><span class="p">[</span><span class="s1">&#39;detection_classes&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="o">+</span> <span class="n">label_id_offset</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
          <span class="n">detections</span><span class="p">[</span><span class="s1">&#39;detection_scores&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
          <span class="n">category_index</span><span class="p">,</span>
          <span class="n">use_normalized_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
          <span class="n">max_boxes_to_draw</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
          <span class="n">min_score_thresh</span><span class="o">=.</span><span class="mi">30</span><span class="p">,</span>
          <span class="n">agnostic_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image_np_with_detections</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># sphinx_gallery_thumbnail_number = 2</span>
</pre></div>
</div>
<ul class="sphx-glr-horizontal">
<li><img alt="plot object detection simple" class="sphx-glr-multi-img" src="../_images/sphx_glr_plot_object_detection_simple_001.png" />
</li>
<li><img alt="plot object detection simple" class="sphx-glr-multi-img" src="../_images/sphx_glr_plot_object_detection_simple_002.png" />
</li>
</ul>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Running inference for image1.jpg... Done
Running inference for image2.jpg... Done
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 2 minutes  29.261 seconds)</p>
<div class="sphx-glr-footer class sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-examples-plot-object-detection-simple-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/cbc63cc7463d82d360a24cb612cedafe/plot_object_detection_simple.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_object_detection_simple.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/1a3be7f9b5153f8f6d44c96a51032716/plot_object_detection_simple.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_object_detection_simple.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../issues.html" class="btn btn-neutral float-right" title="Common issues" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="object_detection_camera.html" class="btn btn-neutral float-left" title="Detect Objects Using Your Webcam" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Lyudmil Vladimirov

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>